import{r as U,ag as De,v as ge,n as Ge,q as z,w as W,o as Ye,F as Q,f as Ie,z as oe,a6 as se,c as Fe,B as ce,E as H,k as P,Y as Je,I as ue,A as Xe,l as Ze,j as et,as as tt,au as nt,at as ot,K as st,V as it,L as D,M as G,O as y,Z as A,Q as x,T as q,W as ve,R as at,X as Y,G as rt,S as lt,a as Me}from"./index.927995fe.js";import{c as ie}from"./selection.0264e392.js";import{u as ct,a as ut,b as dt,c as ht}from"./use-timeout.afd034c5.js";import{p as ye,a as F,u as ft,b as pt,c as mt,h as gt,i as vt,f as yt,Q as bt}from"./welcome.9367a148.js";import{c as wt,s as kt,g as xt}from"./scroll.62b7b14d.js";import{a as J}from"./QItem.02426fde.js";import{i as Tt}from"./vue-qrcode.esm.cd19a419.js";import{i as X,a as Et,K as ae,d as be,f as I,I as St,H as Z,L as we,O as re,Q as ke,R as xe,S as Te,T as Ee,U as _t,j as Se,V as ee,g as Pt,G as te,W as Nt,p as _e,e as Pe,t as R}from"./ui.d5c1e1dd.js";import{u as T}from"./index.463654f8.js";const Ae={target:{type:[Boolean,String,Element],default:!0},noParentEvent:Boolean},an={...Ae,contextMenu:Boolean};function Ct({showing:e,avoidEmit:t,configureAnchorEl:o}){const{props:n,proxy:s,emit:a}=Ie(),i=U(null);let r=null;function c(l){return i.value===null?!1:l===void 0||l.touches===void 0||l.touches.length<=1}const u={};o===void 0&&(Object.assign(u,{hide(l){s.hide(l)},toggle(l){s.toggle(l),l.qAnchorHandled=!0},toggleKey(l){De(l,13)===!0&&u.toggle(l)},contextClick(l){s.hide(l),ge(l),Ge(()=>{s.show(l),l.qAnchorHandled=!0})},prevent:ge,mobileTouch(l){if(u.mobileCleanup(l),c(l)!==!0)return;s.hide(l),i.value.classList.add("non-selectable");const d=l.target;z(u,"anchor",[[d,"touchmove","mobileCleanup","passive"],[d,"touchend","mobileCleanup","passive"],[d,"touchcancel","mobileCleanup","passive"],[i.value,"contextmenu","prevent","notPassive"]]),r=setTimeout(()=>{r=null,s.show(l),l.qAnchorHandled=!0},300)},mobileCleanup(l){i.value.classList.remove("non-selectable"),r!==null&&(clearTimeout(r),r=null),e.value===!0&&l!==void 0&&ie()}}),o=function(l=n.contextMenu){if(n.noParentEvent===!0||i.value===null)return;let d;l===!0?s.$q.platform.is.mobile===!0?d=[[i.value,"touchstart","mobileTouch","passive"]]:d=[[i.value,"mousedown","hide","passive"],[i.value,"contextmenu","contextClick","notPassive"]]:d=[[i.value,"click","toggle","passive"],[i.value,"keyup","toggleKey","passive"]],z(u,"anchor",d)});function f(){oe(u,"anchor")}function g(l){for(i.value=l;i.value.classList.contains("q-anchor--skip");)i.value=i.value.parentNode;o()}function b(){if(n.target===!1||n.target===""||s.$el.parentNode===null)i.value=null;else if(n.target===!0)g(s.$el.parentNode);else{let l=n.target;if(typeof n.target=="string")try{l=document.querySelector(n.target)}catch{l=void 0}l!=null?(i.value=l.$el||l,o()):(i.value=null,console.error(`Anchor: target "${n.target}" not found`))}}return W(()=>n.contextMenu,l=>{i.value!==null&&(f(),o(l))}),W(()=>n.target,()=>{i.value!==null&&f(),b()}),W(()=>n.noParentEvent,l=>{i.value!==null&&(l===!0?f():o())}),Ye(()=>{b(),t!==!0&&n.modelValue===!0&&i.value===null&&a("update:modelValue",!1)}),Q(()=>{r!==null&&clearTimeout(r),f()}),{anchorEl:i,canShow:c,anchorEvents:u}}function qt(e,t){const o=U(null);let n;function s(r,c){const u=`${c!==void 0?"add":"remove"}EventListener`,f=c!==void 0?c:n;r!==window&&r[u]("scroll",f,se.passive),window[u]("scroll",f,se.passive),n=c}function a(){o.value!==null&&(s(o.value),o.value=null)}const i=W(()=>e.noParentEvent,()=>{o.value!==null&&(a(),t())});return Q(i),{localScrollTarget:o,unconfigureScrollTarget:a,changeScrollEvent:s}}const{notPassiveCapture:B}=se,N=[];function j(e){const t=e.target;if(t===void 0||t.nodeType===8||t.classList.contains("no-pointer-events")===!0)return;let o=ye.length-1;for(;o>=0;){const n=ye[o].$;if(n.type.name==="QTooltip"){o--;continue}if(n.type.name!=="QDialog")break;if(n.props.seamless!==!0)return;o--}for(let n=N.length-1;n>=0;n--){const s=N[n];if((s.anchorEl.value===null||s.anchorEl.value.contains(t)===!1)&&(t===document.body||s.innerRef.value!==null&&s.innerRef.value.contains(t)===!1))e.qClickOutside=!0,s.onClickOutside(e);else return}}function Ht(e){N.push(e),N.length===1&&(document.addEventListener("mousedown",j,B),document.addEventListener("touchstart",j,B))}function Ne(e){const t=N.findIndex(o=>o===e);t!==-1&&(N.splice(t,1),N.length===0&&(document.removeEventListener("mousedown",j,B),document.removeEventListener("touchstart",j,B)))}let Ce,qe;function He(e){const t=e.split(" ");return t.length!==2?!1:["top","center","bottom"].includes(t[0])!==!0?(console.error("Anchor/Self position must start with one of top/center/bottom"),!1):["left","middle","right","start","end"].includes(t[1])!==!0?(console.error("Anchor/Self position must end with one of left/middle/right/start/end"),!1):!0}function Wt(e){return e?!(e.length!==2||typeof e[0]!="number"||typeof e[1]!="number"):!0}const le={"start#ltr":"left","start#rtl":"right","end#ltr":"right","end#rtl":"left"};["left","middle","right"].forEach(e=>{le[`${e}#ltr`]=e,le[`${e}#rtl`]=e});function We(e,t){const o=e.split(" ");return{vertical:o[0],horizontal:le[`${o[1]}#${t===!0?"rtl":"ltr"}`]}}function Lt(e,t){let{top:o,left:n,right:s,bottom:a,width:i,height:r}=e.getBoundingClientRect();return t!==void 0&&(o-=t[1],n-=t[0],a+=t[1],s+=t[0],i+=t[0],r+=t[1]),{top:o,bottom:a,height:r,left:n,right:s,width:i,middle:n+(s-n)/2,center:o+(a-o)/2}}function Kt(e,t,o){let{top:n,left:s}=e.getBoundingClientRect();return n+=t.top,s+=t.left,o!==void 0&&(n+=o[1],s+=o[0]),{top:n,bottom:n+1,height:1,left:s,right:s+1,width:1,middle:s,center:n}}function Dt(e,t){return{top:0,center:t/2,bottom:t,left:0,middle:e/2,right:e}}function Le(e,t,o,n){return{top:e[o.vertical]-t[n.vertical],left:e[o.horizontal]-t[n.horizontal]}}function Re(e,t=0){if(e.targetEl===null||e.anchorEl===null||t>5)return;if(e.targetEl.offsetHeight===0||e.targetEl.offsetWidth===0){setTimeout(()=>{Re(e,t+1)},10);return}const{targetEl:o,offset:n,anchorEl:s,anchorOrigin:a,selfOrigin:i,absoluteOffset:r,fit:c,cover:u,maxHeight:f,maxWidth:g}=e;if(Fe.is.ios===!0&&window.visualViewport!==void 0){const C=document.body.style,{offsetLeft:v,offsetTop:w}=window.visualViewport;v!==Ce&&(C.setProperty("--q-pe-left",v+"px"),Ce=v),w!==qe&&(C.setProperty("--q-pe-top",w+"px"),qe=w)}const{scrollLeft:b,scrollTop:l}=o,d=r===void 0?Lt(s,u===!0?[0,0]:n):Kt(s,r,n);Object.assign(o.style,{top:0,left:0,minWidth:null,minHeight:null,maxWidth:g,maxHeight:f,visibility:"visible"});const{offsetWidth:E,offsetHeight:L}=o,{elWidth:O,elHeight:M}=c===!0||u===!0?{elWidth:Math.max(d.width,E),elHeight:u===!0?Math.max(d.height,L):L}:{elWidth:E,elHeight:L};let m={maxWidth:g,maxHeight:f};(c===!0||u===!0)&&(m.minWidth=d.width+"px",u===!0&&(m.minHeight=d.height+"px")),Object.assign(o.style,m);const S=Dt(O,M);let h=Le(d,S,a,i);if(r===void 0||n===void 0)ne(h,d,S,a,i);else{const{top:C,left:v}=h;ne(h,d,S,a,i);let w=!1;if(h.top!==C){w=!0;const k=2*n[1];d.center=d.top-=k,d.bottom-=k+2}if(h.left!==v){w=!0;const k=2*n[0];d.middle=d.left-=k,d.right-=k+2}w===!0&&(h=Le(d,S,a,i),ne(h,d,S,a,i))}m={top:h.top+"px",left:h.left+"px"},h.maxHeight!==void 0&&(m.maxHeight=h.maxHeight+"px",d.height>h.maxHeight&&(m.minHeight=m.maxHeight)),h.maxWidth!==void 0&&(m.maxWidth=h.maxWidth+"px",d.width>h.maxWidth&&(m.minWidth=m.maxWidth)),Object.assign(o.style,m),o.scrollTop!==l&&(o.scrollTop=l),o.scrollLeft!==b&&(o.scrollLeft=b)}function ne(e,t,o,n,s){const a=o.bottom,i=o.right,r=wt(),c=window.innerHeight-r,u=document.body.clientWidth;if(e.top<0||e.top+a>c)if(s.vertical==="center")e.top=t[n.vertical]>c/2?Math.max(0,c-a):0,e.maxHeight=Math.min(a,c);else if(t[n.vertical]>c/2){const f=Math.min(c,n.vertical==="center"?t.center:n.vertical===s.vertical?t.bottom:t.top);e.maxHeight=Math.min(a,f),e.top=Math.max(0,f-a)}else e.top=Math.max(0,n.vertical==="center"?t.center:n.vertical===s.vertical?t.top:t.bottom),e.maxHeight=Math.min(a,c-e.top);if(e.left<0||e.left+i>u)if(e.maxWidth=Math.min(i,u),s.horizontal==="middle")e.left=t[n.horizontal]>u/2?Math.max(0,u-i):0;else if(t[n.horizontal]>u/2){const f=Math.min(u,n.horizontal==="middle"?t.middle:n.horizontal===s.horizontal?t.right:t.left);e.maxWidth=Math.min(i,f),e.left=Math.max(0,f-e.maxWidth)}else e.left=Math.max(0,n.horizontal==="middle"?t.middle:n.horizontal===s.horizontal?t.left:t.right),e.maxWidth=Math.min(i,u-e.left)}var rn=ce({name:"QTooltip",inheritAttrs:!1,props:{...Ae,...ct,...F,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null},transitionShow:{...F.transitionShow,default:"jump-down"},transitionHide:{...F.transitionHide,default:"jump-up"},anchor:{type:String,default:"bottom middle",validator:He},self:{type:String,default:"top middle",validator:He},offset:{type:Array,default:()=>[14,14],validator:Wt},scrollTarget:kt,delay:{type:Number,default:0},hideDelay:{type:Number,default:0},persistent:Boolean},emits:[...ut],setup(e,{slots:t,emit:o,attrs:n}){let s,a;const i=Ie(),{proxy:{$q:r}}=i,c=U(null),u=U(!1),f=H(()=>We(e.anchor,r.lang.rtl)),g=H(()=>We(e.self,r.lang.rtl)),b=H(()=>e.persistent!==!0),{registerTick:l,removeTick:d}=ft(),{registerTimeout:E}=dt(),{transitionProps:L,transitionStyle:O}=pt(e),{localScrollTarget:M,changeScrollEvent:m,unconfigureScrollTarget:S}=qt(e,pe),{anchorEl:h,canShow:C,anchorEvents:v}=Ct({showing:u,configureAnchorEl:je}),{show:w,hide:k}=ht({showing:u,canShow:C,handleShow:Ue,handleHide:ze,hideOnRouteChange:b,processOnMount:!0});Object.assign(v,{delayShow:Qe,delayHide:Be});const{showPortal:de,hidePortal:he,renderPortal:$e}=mt(i,c,Ve,"tooltip");if(r.platform.is.mobile===!0){const p={anchorEl:h,innerRef:c,onClickOutside(_){return k(_),_.target.classList.contains("q-dialog__backdrop")&&Xe(_),!0}},V=H(()=>e.modelValue===null&&e.persistent!==!0&&u.value===!0);W(V,_=>{(_===!0?Ht:Ne)(p)}),Q(()=>{Ne(p)})}function Ue(p){de(),l(()=>{a=new MutationObserver(()=>K()),a.observe(c.value,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),K(),pe()}),s===void 0&&(s=W(()=>r.screen.width+"|"+r.screen.height+"|"+e.self+"|"+e.anchor+"|"+r.lang.rtl,K)),E(()=>{de(!0),o("show",p)},e.transitionDuration)}function ze(p){d(),he(),fe(),E(()=>{he(!0),o("hide",p)},e.transitionDuration)}function fe(){a!==void 0&&(a.disconnect(),a=void 0),s!==void 0&&(s(),s=void 0),S(),oe(v,"tooltipTemp")}function K(){Re({targetEl:c.value,offset:e.offset,anchorEl:h.value,anchorOrigin:f.value,selfOrigin:g.value,maxHeight:e.maxHeight,maxWidth:e.maxWidth})}function Qe(p){if(r.platform.is.mobile===!0){ie(),document.body.classList.add("non-selectable");const V=h.value,_=["touchmove","touchcancel","touchend","click"].map(me=>[V,me,"delayHide","passiveCapture"]);z(v,"tooltipTemp",_)}E(()=>{w(p)},e.delay)}function Be(p){r.platform.is.mobile===!0&&(oe(v,"tooltipTemp"),ie(),setTimeout(()=>{document.body.classList.remove("non-selectable")},10)),E(()=>{k(p)},e.hideDelay)}function je(){if(e.noParentEvent===!0||h.value===null)return;const p=r.platform.is.mobile===!0?[[h.value,"touchstart","delayShow","passive"]]:[[h.value,"mouseenter","delayShow","passive"],[h.value,"mouseleave","delayHide","passive"]];z(v,"anchor",p)}function pe(){if(h.value!==null||e.scrollTarget!==void 0){M.value=xt(h.value,e.scrollTarget);const p=e.noParentEvent===!0?K:k;m(M.value,p)}}function Oe(){return u.value===!0?P("div",{...n,ref:c,class:["q-tooltip q-tooltip--style q-position-engine no-pointer-events",n.class],style:[n.style,O.value],role:"tooltip"},ue(t.default)):null}function Ve(){return P(Je,L.value,Oe)}return Q(fe),Object.assign(i.proxy,{updatePosition:K}),$e}});function ln(e){e=e.replace("https://",""),e=e.replace("http://","");const t=26;return e.length>t&&e.indexOf("/")!=-1&&(e=e.substring(0,e.indexOf("/")+1)+"..."+e.substring(e.length-t/2,e.length)),e.length>t&&(e=e.substring(0,t/2)+"..."+e.substring(e.length-t/2,e.length)),e}function Ke(e){if(e===!1)return 0;if(e===!0||e===void 0)return 1;const t=parseInt(e,10);return isNaN(t)?0:t}var It=Ze({name:"close-popup",beforeMount(e,{value:t}){const o={depth:Ke(t),handler(n){o.depth!==0&&setTimeout(()=>{const s=gt(e);s!==void 0&&vt(s,n,o.depth)})},handlerKey(n){De(n,13)===!0&&o.handler(n)}};e.__qclosepopup=o,e.addEventListener("click",o.handler),e.addEventListener("keyup",o.handlerKey)},updated(e,{value:t,oldValue:o}){t!==o&&(e.__qclosepopup.depth=Ke(t))},beforeUnmount(e){const t=e.__qclosepopup;e.removeEventListener("click",t.handler),e.removeEventListener("keyup",t.handlerKey),delete e.__qclosepopup}});const Mt={ratio:[String,Number]};function At(e,t){return H(()=>{const o=Number(e.ratio||(t!==void 0?t.value:void 0));return isNaN(o)!==!0&&o>0?{paddingBottom:`${100/o}%`}:null})}var Rt=ce({name:"QResponsive",props:Mt,setup(e,{slots:t}){const o=At(e);return()=>P("div",{class:"q-responsive"},[P("div",{class:"q-responsive__filler overflow-hidden"},[P("div",{style:o.value})]),P("div",{class:"q-responsive__content absolute-full fit"},ue(t.default))])}}),$t=ce({name:"QCardSection",props:{tag:{type:String,default:"div"},horizontal:Boolean},setup(e,{slots:t}){const o=H(()=>`q-card__section q-card__section--${e.horizontal===!0?"horiz row no-wrap":"vert"}`);return()=>P(e.tag,{class:o.value},ue(t.default))}});const Ut=et({name:"P2PKDialog",mixins:[windowMixin],components:{VueQrcode:Tt},data:function(){return{}},computed:{...tt(X,["p2pkKeys","showP2PKData","showLastKey"]),...nt(X,["showP2PKDialog"])},methods:{...ot(X,["generateKeypair","showKeyDetails"]),newKeys:function(){this.generateKeypair(),this.showLastKey()}}}),zt={class:"text-center q-mb-md q-mt-none q-pt-none"},Qt={class:"row justify-center"},Bt={class:"row justify-center"},jt={key:0,class:"row justify-center q-pt-sm"},Ot={key:1,class:"row justify-center q-pt-sm"},Vt={class:"row q-mt-lg"};function Gt(e,t,o,n,s,a){const i=it("vue-qrcode");return D(),G(bt,{modelValue:e.showP2PKDialog,"onUpdate:modelValue":t[1]||(t[1]=r=>e.showP2PKDialog=r),position:"top","backdrop-filter":"blur(2px) brightness(60%)"},{default:y(()=>[e.showP2PKData.publicKey?(D(),G(yt,{key:0,class:"q-px-lg q-pt-md q-pb-md qcard"},{default:y(()=>[A("div",zt,[x(Rt,{ratio:1,class:"q-mx-md q-mt-none q-pt-none"},{default:y(()=>[x(i,{value:e.showP2PKData.publicKey,options:{width:340},class:"rounded-borders"},null,8,["value"])]),_:1}),A("div",Qt,[x($t,{class:"q-pa-sm"},{default:y(()=>[A("div",Bt,[x(J,{overline:"",class:"q-mb-sm q-pt-md text-white"},{default:y(()=>t[2]||(t[2]=[q(" P2PK Key")])),_:1})]),e.showP2PKData.used?(D(),ve("div",jt,[x(J,{caption:"",class:"text-weight-bold text-warning",style:{"font-size":"14px"}},{default:y(()=>t[3]||(t[3]=[q("Warning: This key was used before. Use a new key for better privacy.")])),_:1})])):(D(),ve("div",Ot,[x(J,{caption:"",class:"text-weight-light text-white",style:{"font-size":"14px"}},{default:y(()=>t[4]||(t[4]=[q("Receive ecash locked to this key")])),_:1})]))]),_:1})]),x(Y,{class:"q-mx-xs q-px-md q-mt-md",size:"md",color:"primary",flat:"",rounded:"",dense:"",onClick:e.newKeys},{default:y(()=>[x(at,{name:"refresh",class:"q-pr-sm",size:"xs"}),t[5]||(t[5]=q(" Generate new key"))]),_:1},8,["onClick"]),A("div",Vt,[x(Y,{class:"q-mx-xs",size:"md",flat:"",onClick:t[0]||(t[0]=r=>e.copyText(e.showP2PKData.publicKey))},{default:y(()=>t[6]||(t[6]=[q("Copy")])),_:1}),rt((D(),G(Y,{flat:"",color:"grey",class:"q-ml-auto"},{default:y(()=>t[7]||(t[7]=[q("Close")])),_:1})),[[It]])])])]),_:1})):lt("",!0)]),_:1},8,["modelValue"])}var cn=st(Ut,[["render",Gt]]);const $={NWCInfo:13194,NWCRequest:23194,NWCResponse:23195},un=Me("nwc",{state:()=>({nwcEnabled:T("cashu.nwc.enabled",!1),connections:T("cashu.nwc.connections",[]),seenCommandsUntil:T("cashu.nwc.seenCommandsUntil",0),supportedMethods:["pay_invoice","make_invoice","get_balance","get_info","list_transactions","lookup_invoice"],relays:T("cashu.nwc.relays",Et().defaultNostrRelays),blocking:!1,ndk:new ae,subscriptions:[],showNWCDialog:!1,showNWCData:{connection:{},connectionString:""}}),getters:{},actions:{handleGetInfo:async function(e){return console.log("### get_info",e.method),{result_type:"get_info",result:{alias:"Cashu.me",color:"#FF0000",pubkey:this.connections[0].walletPublicKey,network:"mainnet",block_height:1,block_hash:"blockchain disrespectoor",methods:this.supportedMethods}}},handleGetBalance:async function(e){const t=be();return console.log("### get_balance",e.method),{result_type:"get_balance",result:{balance:t.activeBalance*1e3}}},handlePayInvoice:async function(e){const t=e.params.invoice,o=e.params.amount;console.log("### pay_invoice",e.method),console.log("### invoice",t),console.log("### amountMsat",o);const n=I(),s=St(),a=be();try{await n.decodeRequest(t)}catch(r){return console.log("### error decoding invoice",r),{result_type:e.method,error:{code:"INTERNAL",message:"Invalid invoice"}}}if(n.payInvoiceData.meltQuote.response.amount==0||n.payInvoiceData.meltQuote.error)return Z("NWC: Error requesting melt quote"),{result_type:e.method,error:{code:"INTERNAL",message:"Error requesting melt quote"}};const i=n.payInvoiceData.meltQuote.response.amount+n.payInvoiceData.meltQuote.response.fee_reserve;if(a.activeUnit!="sat")return Z("NWC: Active unit must be sats"),{result_type:e.method,error:{code:"INTERNAL",message:"Your active must be sats"}};if(i>this.connections[0].allowanceLeft)return Z("NWC: Allowance exceeded"),{result_type:e.method,error:{code:"QUOTA_EXCEEDED",message:"Your quota has exceeded"}};try{const r=await n.meltInvoiceData(),c=n.payInvoiceData.meltQuote.response.amount+n.payInvoiceData.meltQuote.response.fee_reserve-s.sumProofs(r.change);return this.connections[0].allowanceLeft-=c,{result_type:e.method,result:{}}}catch{return{result_type:e.method,error:{code:"INTERNAL",message:"Could not pay invoice"}}}},handleMakeInvoice:async function(e){const{amount:t,description:o,expiry:n}=e.params;console.log("### make_invoice"),console.log("### amount",t),console.log("### description",o),console.log("### expiry",n);const s=I(),a=await s.requestMint(t/1e3,s.wallet);return a?(s.mintOnPaid(a.quote,!1,!0),{result_type:e.method,result:{type:"incoming",invoice:a?.request,description:o,amount:t}}):{result_type:e.method,error:{code:"INTERNAL",message:"failed to request mint invoice"}}},handleListTransactions:async function(e){console.log("### list_transactions",e.method);const t=I(),o=e.params.from||0,n=e.params.until||Math.floor(Date.now()/1e3),s=e.params.limit||10,a=e.params.offset||0,i=e.params.unpaid||!1,r=e.params.type||void 0,f=t.invoiceHistory.filter(g=>{const b=new Date(g.date),l=Math.floor(b.getTime()/1e3);return!(o&&l<o||n&&l>n||r&&r=="incoming"&&g.amount<0||r&&r=="outgoing"&&g.amount>0||i&&g.status=="paid")}).slice(a,a+s).map(this.mapToNwcTransaction);return{result_type:"list_transactions",result:{transactions:f}}},handleLookupInvoice:async function(e){let t=e.params.payment_hash;if(!t){const s=e.params.invoice;t=(s?we.decode(s):null)?.sections.find(i=>i.name==="payment_hash")?.value}if(!t)return{result_type:e.method,error:{code:"OTHER",message:"invoice or payment_hash required"}};console.log("### lookup_invoice");const n=I().invoiceHistory;for(const s of n)if(we.decode(e.params.invoice).sections.find(r=>r.name==="payment_hash")?.value===t)return{result_type:e.method,result:this.mapToNwcTransaction(s)};return{result_type:e.method,error:{code:"NOT_FOUND",message:"invoice not found"}}},mapToNwcTransaction(e){let t=e.amount>0?"incoming":"outgoing",o=Math.abs(e.amount)*1e3,n=Math.floor(new Date(e.date).getTime()/1e3),s=e.status=="paid"?Math.floor(new Date(e.date).getTime()/1e3):null;return{type:t,invoice:e.bolt11,description:e.memo,amount:o,fees_paid:0,created_at:n,settled_at:s}},replyNWC:async function(e,t,o){let n=new re(t.ndk);n.kind=23195,console.log("### replying with",JSON.stringify(e)),n.content=await ke.encrypt(o.walletPrivateKey,t.author.pubkey,JSON.stringify(e)),n.tags=[["p",t.author.pubkey],["e",t.id]],console.log("### replyEvent",n),console.log("### replying to",t.id),await n.publish()},parseNWCCommand:async function(e,t,o){let n=JSON.parse(e),s;if(console.log("### nwcCommand",n),n.method=="get_info")s=await this.handleGetInfo(n);else if(n.method=="get_balance")s=await this.handleGetBalance(n);else if(n.method=="pay_invoice"){this.blocking&&(s={result_type:n.method,error:{code:"INTERNAL",message:"Already processing a payment."}}),this.blocking=!0;try{s=await this.handlePayInvoice(n)}catch{return}finally{this.blocking=!1}}else n.method==="make_invoice"?s=await this.handleMakeInvoice(n):n.method=="list_transactions"?s=await this.handleListTransactions(n):n.method==="lookup_invoice"?s=await this.handleLookupInvoice(n):(console.log("### method not supported",n.method),s={result_type:n.method,error:{code:"NOT_IMPLEMENTED",message:"Method not supported"}});await this.replyNWC(s,t,o)},getConnectionString:function(e){const t=e.walletPublicKey,o=e.connectionSecret;return`nostr+walletconnect://${t}?relay=${this.relays.join("&relay=")}&secret=${o}`},generateNWCConnection:async function(){let e;if(this.connections.length)e=this.connections[0];else{const n=xe(),s=Te(n),a=Ee(n),i=xe(),r=Te(i),c=Ee(i);e={walletPublicKey:s,walletPrivateKey:a,connectionSecret:c,connectionPublicKey:r,allowanceLeft:1e3},this.connections=this.connections.concat(e)}const t=new _t(e.walletPrivateKey);this.unsubscribeNWC(),this.ndk=new ae({explicitRelayUrls:this.relays,signer:t}),this.ndk.connect();const o=new re(this.ndk);o.kind=$.NWCInfo,o.content=this.supportedMethods.join(" ");try{let n={kinds:[$.NWCInfo],authors:[e.walletPublicKey]};(await this.ndk.fetchEvents(n)).size===0?(await o.publish(),console.log("### published nip47InfoEvent",o)):console.log("### nip47InfoEvent already published")}catch(n){console.log("### could not publish nip47InfoEvent",o),console.log("### error",n)}},listenToNWCCommands:async function(){await this.generateNWCConnection();const e=this.connections[0],o=Math.floor(Date.now()/1e3)-60;let n={kinds:[$.NWCRequest],since:o,authors:[e.connectionPublicKey],"#p":[e.walletPublicKey]};const s=this.ndk.subscribe(n);console.log("### subscribing to NWC on relays: ",this.relays),this.subscriptions.push(s),s.on("eose",()=>console.log("All relays have reached the end of the event stream")),s.on("close",()=>console.log("Subscription closed")),s.on("event",async a=>{if(a.kind!=$.NWCRequest)return;if(!this.nwcEnabled){console.log("### Received NWC command but NWC is disabled");return}if(a.created_at<=this.seenCommandsUntil)return;this.seenCommandsUntil=a.created_at,console.log("### NWC request!"),console.log("### event",a);const i=await ke.decrypt(e.connectionSecret,e.walletPublicKey,a.content);await this.parseNWCCommand(i,a,e)})},unsubscribeNWC:function(){console.log("### unsubscribing from NWC");for(let e of this.subscriptions)e.stop();this.subscriptions=[]}}}),Yt=27235,dn=Me("npc",{state:()=>({npcEnabled:T("cashu.npc.enabled",!0),automaticClaim:T("cashu.npc.automaticClaim",!0),npcAddress:T("cashu.npc.address",""),npcDomain:T("cashu.npc.domain","npub.cash"),baseURL:T("cashu.npc.baseURL","https://npub.cash"),npcLoading:!1}),getters:{},actions:{generateNPCConnection:async function(){const e=Se();if(!e.pubkey)return;const t=e.pubkey;console.log("Lightning address for wallet:",ee.npubEncode(t)+"@"+this.npcDomain),console.log("npub:",ee.npubEncode(t)),this.baseURL=`https://${this.npcDomain}`;const o=this.npcAddress;if(this.npcAddress=ee.npubEncode(t)+"@"+this.npcDomain,!!this.npcEnabled){this.npcLoading=!0;try{const n=await this.getInfo();if(n.error){Pt(n.error);return}if(console.log(n),n.username){const s=n.username+"@"+this.npcDomain;o!==s&&te(`Logged in as ${n.username}`),this.npcAddress=s}}catch(n){Nt(n)}finally{this.npcLoading=!1}}},generateNip98Event:async function(e,t,o){const n=Se();await n.initSignerIfNotSet();const s=new re(new ae);s.kind=Yt,s.content="",s.tags=[["u",e],["method",t]],await s.sign(n.signer);const a=JSON.stringify(s.rawEvent());return btoa(a)},getInfo:async function(){const e=await this.generateNip98Event(`${this.baseURL}/api/v1/info`,"GET");try{return await(await fetch(`${this.baseURL}/api/v1/info`,{method:"GET",headers:{Authorization:`Nostr ${e}`}})).json()}catch(t){return console.error(t),{mintUrl:"",npub:"",username:""}}},claimAllTokens:async function(){if(!this.npcEnabled)return;const e=_e(),t=await this.getBalance();if(console.log("npub.cash balance: "+t),t>0){te(`You have ${t} sats on npub.cash`);const o=await this.getClaim();if(o)if(this.addPendingTokenToHistory(o),e.receiveData.tokensBase64=o,this.automaticClaim)try{await I().redeem()}catch{e.showReceiveTokens=!0}else e.showReceiveTokens=!0}},tokenAlreadyInHistory:function(e){return Pe().historyTokens.find(o=>o.token===e)!==void 0},addPendingTokenToHistory:function(e){const t=_e();if(this.tokenAlreadyInHistory(e)){te("Ecash already in history"),t.showReceiveTokens=!1;return}const o=Pe(),n=R.decode(e);if(n==null)throw Error("could not decode token");const s=R.getProofs(n).reduce((r,c)=>r+=c.amount,0),a=R.getMint(n),i=R.getUnit(n);o.addPendingToken({amount:s,token:e,mint:a,unit:i}),t.showReceiveTokens=!1},getBalance:async function(){const e=await this.generateNip98Event(`${this.baseURL}/api/v1/balance`,"GET");try{const o=await(await fetch(`${this.baseURL}/api/v1/balance`,{method:"GET",headers:{Authorization:`Nostr ${e}`}})).json();return o.error?0:o.data}catch(t){return console.error(t),0}},getClaim:async function(){const e=await this.generateNip98Event(`${this.baseURL}/api/v1/claim`,"GET");try{const o=await(await fetch(`${this.baseURL}/api/v1/claim`,{method:"GET",headers:{Authorization:`Nostr ${e}`}})).json();return o.error?"":o.data.token}catch(t){return console.error(t),""}}}});export{It as C,cn as P,rn as Q,Wt as a,qt as b,Ct as c,Ht as d,Rt as e,$t as f,ln as g,Mt as h,At as i,un as j,dn as k,We as p,Ne as r,Re as s,an as u,He as v};
